#!/usr/bin/env bash

set -Eeuo pipefail

apt-mark hold linux-image-amd64

systemctl enable haveged
systemctl enable ipmievd
# systemctl enable irqbalance

update-kernel-cmdline
mkdir -p /boot/efi/Default

for kernel in /boot/vmlinuz-*; do
   dracut -f /boot/initrd.img-${kernel#*-} ${kernel#*-} -m "bash dash systemd systemd-initrd kernel-modules kernel-modules-extra terminfo udev-rules dracut-systemd gardenlinux base fs-lib shutdown" --reproducible
   dracut -f /boot/unified_boot_image.efi-${kernel#*-} ${kernel#*-} -m "bash dash systemd systemd-initrd kernel-modules kernel-modules-extra terminfo udev-rules dracut-systemd gardenlinux base fs-lib shutdown" --reproducible --uefi
   /usr/bin/kernel-install add "${kernel#*-}" "${kernel}" "/boot/initrd.img-${kernel#*-}"
done

# bootloader
mkdir -p /boot/efi/syslinux
cp /usr/lib/syslinux/modules/bios/menu.c32 /boot/efi/syslinux/
cp /usr/lib/syslinux/modules/bios/libutil.c32 /boot/efi/syslinux/

# fix path for the loader
# needed because /boot/efi is not a mountpoint at this point
sed 's/boot\/efi//' -i /boot/efi/loader/entries/*.conf

update-syslinux
